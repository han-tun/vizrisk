<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>The Rise of Kpop in Chicago</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.1/TweenMax.min.js"></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script>
  <script src="https://unpkg.com/scrollama"></script>
  <style media="screen">
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 60%;
    }

    svg {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    circle {
      stroke-width: 0;

    }

    section {
      padding: 25px 50px;
      line-height: 25px;
      margin: 200px 25px 200px 25px;
      opacity: 0.05;
      font-size: 20px;
      color: #000;
      ;
    }

    section.active {
      opacity: 0.8;
    }

    section:last-child {
      border-bottom: none;
      margin-bottom: 1000px;
    }

    #features {
      width: 40%;
      margin-left: 60%;
      font-family: 'Roboto', sans-serif;
      overflow-y: scroll;
      background-color: #fafafa;
    }

    path,
    #arrowhead {
      fill: none;
      stroke: #7E7D7E;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id='features'>
    <section id='welcome' class='step' step-num='1'>
      <h3>Welcome</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section1' class='step' step-num='2'>
      <h3>Landers before</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section2' class='step' step-num='3'>
      <h3>Landers mainshock</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section3' class='step' step-num='4'>
      <h3>Landers aftershocks</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section4' class='step' step-num='5'>
      <h3>Landers triggered</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section5' class='step' step-num='6'>
      <h3>Chart view</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section6' class='step' step-num='7'>
      <h3>Landers above M5</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <!-- <section id='section7' class='step' step-num='8'>
      <h3>Understanding magnitude</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section> -->
    <section id='section8' class='step' step-num='9'>
      <h3>Sumatra before</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section9' class='step' step-num='10'>
      <h3>Sumatra mainshock</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section10' class='step' step-num='11'>
      <h3>Sumatra triggered</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>
    <section id='section11' class='step' step-num='12'>
      <h3>Sumatra strain waves</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute
        irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </section>

  </div>
  <script type="text/javascript">
    //initialize map
    mapboxgl.accessToken = 'pk.eyJ1Ijoid2NoYXNlMTQiLCJhIjoiY2p2dnYwOXBvMGJvNDQzcDkxcTZqNWd3dCJ9.UqxE9xtZJevAQem-lKCYnA';
    let map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/wchase14/cjwh8fgh00omd1clb4krxzcxj',
      center: [11.634, 25.448],
      zoom: 1.1,
      interactive: false
    });
    //for polygons
    //area for mapbox fly-tos
    let chapters = {
      'welcome': {
        bearing: 0,
        center: [11.634, 25.448],
        zoom: 1.1,
        speed: 0.6,
        pitch: 0
      },
      'section1': {
        bearing: 0,
        center: [-108.139, 39.404],
        zoom: 3.94,
        speed: 0.7,
        pitch: 0
      },
      'section2': {
        center: [-87.887091, 42.004897],
        bearing: 14.40,
        zoom: 16.00,
        speed: 0.5,
        pitch: 53.50
      },
      'section3': {
        bearing: 14.40,
        center: [-87.673674, 41.880015],
        zoom: 16.00,
        speed: 0.5,
        pitch: 53.50
      },
      'section4': {
        bearing: 0.00,
        center: [-87.615715, 41.861087],
        zoom: 15.78,
        speed: 0.5,
        pitch: 60.00
      },
    };

    //function to draw strain waves
    map.on('load', function () {
      map.addSource('strainWavesDat', {
        type: 'geojson',
        data: 'https://gist.githubusercontent.com/will-r-chase/72b206dd2ba17889ba98075d693db1bd/raw/57b8465a5e85f103e3f6d163ef2ad6294a229a77/strain_waves.geojson'
      });
      map.addLayer({
        "id": "strainWaves",
        "type": "fill",
        "source": "strainWavesDat",
        'layout': {},
        'paint': {
          'fill-color': '#961D72',
          'fill-opacity': 0
      }
    });});

    //////////////////////////
    // Mapbox+D3 Connection
    //////////////////////////
    // Get Mapbox map canvas container
    // Setup svg dims and margins
    let canvas = map.getCanvasContainer();
    let svg = d3.select(canvas).append("svg").attr("id", "my_svg");
    let svgSelect = document.getElementById("my_svg");
    let rect = svgSelect.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;
    const margin = ({
      top: 50,
      right: 30,
      bottom: 70,
      left: 30
    });

    // Set up svg groups so that last one will be on top
    let before = svg.append("g");
    let aftershock = svg.append("g");
    let trigger = svg.append("g");
    let mainshock = svg.append("g");

    // Draw GeoJSON data with d3
    let circles;

    // Scales
    //landers domain [2.5, 7.3]
    aScale = d3.scaleSqrt()
      .range([5, 20]);

    colorScale = d3.scaleSequential(d3.interpolateHcl("#FD8C3D", "#E3191C"));

    timeParse = d3.timeParse("%Y-%m-%d %H:%M:%S");
    timeScale = d3.scaleTime();

    timeScaleBefore = d3.scaleTime()
      .range([margin.left, width / 2 - margin.right]);
    timeScaleTriggered = d3.scaleTime()
      .range([width / 2 + margin.left, width - margin.right]);

    //clean data function
    function clean(data) {
      for (const d of data.features) {
        const date = timeParse(d.properties.time);
        d.properties.date = date;
        d.properties.day = d3.timeDay(date);
      }
      return data;
    };
    //rand number function
    function randNum(min, max) {
      return Math.random() * (max - min) + min;
    }

    //define URLs for data sources
    const landers_before_url = "https://gist.githubusercontent.com/will-r-chase/375d6366e6c32caf3862d1f6154f87a0/raw/f632753fc5940ac57e55276f38bca2262cb87907/landers_before2.geojson";
    const landers_mainshock_url = "https://gist.githubusercontent.com/will-r-chase/97555d4d4870f6acb2d3ca6708a5c61d/raw/3b78c10904ccfd968d5c06b6c8a04f0edc724273/landers_mainshock.geojson";
    const landers_aftershocks_url = "https://gist.githubusercontent.com/will-r-chase/ab84dc036cbe1f444bc27a349bb1a8bb/raw/962b541ef08baaaf10479b88306ca467f7ced355/landers_aftershocks.geojson";
    const landers_triggered_url = "https://gist.githubusercontent.com/will-r-chase/b510d63e4cfabe7c52a053a50a9faeac/raw/a463bddcac56aa827e15a96d372e19854c99373d/landers_triggered2.geojson";
    const sumatra_before_url = "https://gist.githubusercontent.com/will-r-chase/5cb1d0f0d043d3a3420a0be9d0eb3b58/raw/2542da1200c6ce637c4f80f12ff328c7873b564b/sumatra_before.geojson";
    const sumatra_mainshock_url = "https://gist.githubusercontent.com/will-r-chase/5e3e1470002a9bb53465c610faea0959/raw/07c39e495864ecc02aa5b683379af33e3dc9a259/indianOcean_mainshock.geojson";
    const sumatra_triggered_url = "https://gist.githubusercontent.com/will-r-chase/cb0f15205c78e792fda1ffb3a753946f/raw/1c909965e19b283c597a125dc49d70ff92f2f4ae/sumatra_triggered.geojson";

    //define data for magnitude viz
    const magData = [{"id": 1, "mag": 3, "size": 5},
                     {"id": 2, "mag": 4, "size": 50},
                     {"id": 3, "mag": 5, "size": 500},
                     {"id": 4, "mag": 6, "size": 5000},
                     {"id": 5, "mag": 7, "size": 50000},
                     {"id": 6, "mag": 8, "size": 500000},
                     {"id": 7, "mag": 9, "size": 5000000}];

    // For each enter step, read and draw data
    function initData(source, myGroup, myClass, myDomain, myTimeRange, myExtraDelay, myEase = d3.easeCubicInOut, myDuration = 650) {
      d3.json(source, function(err, data) {
        let cleanDat = clean(data)
        drawData(cleanDat, myGroup, myClass, myDomain, myTimeRange, myExtraDelay, myEase, myDuration);
      })
    };

    function initChart(source1, source2) {
      d3.json(source1, function(err, dataBefore) {
        d3.json(source2, function(err, dataTriggered) {
          if (err) console.log(err);
          let cleanBefore = clean(dataBefore);
          let cleanTriggered = clean(dataTriggered);
          drawChart(cleanBefore, cleanTriggered);
        });
      });
    };
    function initChartBackwards(source1, source2) {
      d3.json(source1, function(err, dataBefore) {
        d3.json(source2, function(err, dataTriggered) {
          if (err) console.log(err);
          let cleanBefore = clean(dataBefore);
          let cleanTriggered = clean(dataTriggered);
          drawChartBackwards(cleanBefore, cleanTriggered);
        });
      });
    };
    function initChartHighlight(source1, source2) {
      d3.json(source1, function(err, dataBefore) {
        d3.json(source2, function(err, dataTriggered) {
          if (err) console.log(err);
          let cleanBefore = clean(dataBefore);
          let cleanTriggered = clean(dataTriggered);
          highlightChart(cleanBefore, cleanTriggered);
        });
      });
    };
    function exitChartHighlight(source1, source2) {
      d3.json(source1, function(err, dataBefore) {
        d3.json(source2, function(err, dataTriggered) {
          if (err) console.log(err);
          let cleanBefore = clean(dataBefore);
          let cleanTriggered = clean(dataTriggered);
          reverseHighlightChart(cleanBefore, cleanTriggered);
        });
      });
    };

    function exitChart(source1, source2) {
      d3.json(source1, function(err, dataBefore) {
        d3.json(source2, function(err, dataTriggered) {
          if (err) console.log(err);
          let cleanBefore = clean(dataBefore);
          let cleanTriggered = clean(dataTriggered);
          reverseChart(cleanBefore, cleanTriggered);
        });
      });
    };
    //////////////
    // D3 stuff
    //////////////
    // Project GeoJSON coordinate to the map's current state
    function project(d) {
      return map.project(new mapboxgl.LngLat(+d[0], +d[1]));
    }

    //Main draw function
    function drawData(data, group, pointClass, domain, timeRange, extraDelay = 0, Ease, Duration) {
      // set scale domain
      aScale.domain(domain);
      colorScale.domain(domain);
      timeScale
        .domain(d3.extent(data.features.map(d => d.properties).map(d => d.date)))
        .range(timeRange);
      // Add circles
      circles = group.selectAll(pointClass)
        .data(data.features)
        .enter()
        .append("circle")
        .attr("class", pointClass)
        .attr("r", 0)
        .attr("fill", d => colorScale(d.properties.mag))
        .attr("day", d => d.properties.day)
        .style("opacity", 0.7);

      circles
        .transition()
        .delay(d => extraDelay + timeScale(d.properties.date))
        .duration(Duration)
        .ease(Ease)
        .attr("r", d => aScale(d.properties.mag));
      // Call the update function
      update();
      // Update on map interaction
      map.on("viewreset", update);
      map.on("move", update);
      map.on("moveend", update);
    }
    // Update d3 shapes' positions to the map's current state
    function update() {
      console.log("update");
      svg.selectAll("circle").attr("cx", function(d) {
          return project(d.geometry.coordinates).x
        })
        .attr("cy", function(d) {
          return project(d.geometry.coordinates).y
        });
    }

    //function to draw stacked dot histogram
    function drawChart(dataBefore, dataTriggered) {
      console.log("dataBefore", dataBefore);
      console.log("dataTriggered", dataTriggered);
      timeScaleBefore.domain(d3.extent(dataBefore.features.map(d => d.properties).map(d => d.day)));
      timeScaleTriggered.domain(d3.extent(dataTriggered.features.map(d => d.properties).map(d => d.day)));
      const arrowPath = `M ${width/2 - 130},${height/3.6} C ${width/2 - 130},${height/4 + 60} ${width/2 - 130},${height/4 + 70} ${width/2 - 10},${height/4 + 70}`
      // Define simple arrowhead marker
      svg.append('defs')
        .append("marker")
        .attr("id", "arrowhead")
        .attr("viewBox", "-10 -10 20 20")
        .attr("refX", 0)
        .attr("refY", 0)
        .attr("markerWidth", 20)
        .attr("markerHeight", 20)
        .attr("stroke-width", 1)
        .attr("orient", "auto")
        .append("polyline")
        .attr("stroke-linejoin", "bevel")
        .attr("points", "-6.75,-6.75 0,0 -6.75,6.75");

      //mainshock line
      line = svg.append("g")
        .append("line")
        .attr("x1", width / 2)
        .attr("x2", width / 2)
        .attr("y1", height / 5)
        .attr("y2", height - margin.bottom)
        .attr("class", "mainshock-line")
        .style("opacity", 0)
        .style("stroke", "#E3191C")
        .style("stroke-width", 3)
        .style("stroke-dasharray", 5);
      //x axis before
      axisBefore = svg.append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .attr("class", "chart-axis")
        .style("opacity", 0)
        .call(d3.axisBottom(timeScaleBefore)
          .ticks(5)
          .tickFormat(d3.timeFormat("%b %d"))
          .tickSizeOuter(0));
      //x axis after
      axisTriggered = svg.append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .attr("class", "chart-axis")
        .style("opacity", 0)
        .call(d3.axisBottom(timeScaleTriggered)
          .ticks(5)
          .tickFormat(d3.timeFormat("%b %d"))
          .tickSizeOuter(0));

      axisBefore
        .transition()
        .delay(100)
        .duration(2000)
        .style("opacity", 1);

      beforeLabel = d3.select(canvas)
        .append("div")
        .attr("class", "chart-label")
        .html(
          "Earthquakes 10 days before the Landers mainshock"
        )
        .style("position", "absolute")
        .style("width", "200px")
        .style("opacity", 0)
        .style("left", width / 11 + "px")
        .style("top", height / 1.7 + "px")
        .style("text-anchor", "left")
        .style("font-size", "20px")
        .transition()
        .delay(0) //2500
        .duration(2000)
        .style("opacity", 1);

      before
        .selectAll(".landers-before")
        .data(dataBefore.features)
        .transition()
        .delay(d => 0 + randNum(0, 100) + d.properties.id_overall * 100) //7000
        .attr("r", 10)
        .style("opacity", 1)
        .attr("fill", "#373536")
        .attr("cx", d => timeScaleBefore(d.properties.day))
        .attr("cy", d => height - margin.bottom - (d.properties.id_day * 20));

      mainshockLabel = d3.select(canvas)
        .append("div")
        .attr("class", "chart-label")
        .html(
          "On Jan 28th 1992, a magnitude 7.3 earthquake strikes near Landers, California"
        )
        .style("position", "absolute")
        .style("width", "200px")
        .style("opacity", 0)
        .style("left", width / 2 - 220 + "px")
        .style("top", height / 5.1 + "px")
        .style("text-anchor", "left")
        .style("font-size", "16px")
        .transition()
        .delay(0) //11000
        .duration(2000)
        .style("opacity", 1);

      arrow = svg.append("path")
        .attr('marker-end', 'url(#arrowhead)')
        .attr("d", arrowPath)
        .attr("class", "myArrow")
        .style('opacity', 0)
        .style("fill", "none")
        .attr("stroke-width", 1)
        .attr("stroke", "black")
        .transition()
        .delay(0) //12000
        .duration(1500)
        .style('opacity', 1);

      line
        .transition()
        .delay(0) //13000
        .duration(1000)
        .style("opacity", 1)

      axisTriggered
        .transition()
        .delay(0) //15000
        .duration(2000)
        .style("opacity", 1);

      triggeredLabel = d3.select(canvas)
        .append("div")
        .attr("class", "chart-label")
        .html(
          "Earthquakes 10 days after the Landers mainshock"
        )
        .style("position", "absolute")
        .style("width", "200px")
        .style("opacity", 0)
        .style("left", width / 1.5 + "px")
        .style("top", height / 3.7 + "px")
        .style("text-anchor", "left")
        .style("font-size", "20px")
        .transition()
        .delay(0) //17500
        .duration(2000)
        .style("opacity", 1);

      trigger
        .selectAll(".landers-triggered")
        .data(dataTriggered.features)
        .transition()
        .delay(d => 0 + randNum(20, 150) + d.properties.id_overall * 30) //20000
        .attr("r", 10)
        .style("opacity", 1)
        .attr("fill", "#373536")
        .attr("cx", d => timeScaleTriggered(d.properties.day))
        .attr("cy", d => height - margin.bottom - (d.properties.id_day * 20));

    };
    function drawChartBackwards(dataBefore, dataTriggered) {
      timeScaleBefore.domain(d3.extent(dataBefore.features.map(d => d.properties).map(d => d.day)));
      timeScaleTriggered.domain(d3.extent(dataTriggered.features.map(d => d.properties).map(d => d.day)));

      before
        .selectAll(".landers-before")
        .data(dataBefore.features)
        .attr("r", 10)
        .attr("fill", d => d.properties.mag > 5 ? "#DC0505" : "#373536")
        .style("opacity", d => d.properties.mag > 5 ? 1 : 0.5)
        .attr("cx", d => timeScaleBefore(d.properties.day))
        .attr("cy", d => height - margin.bottom - (d.properties.id_day * 20));


      trigger
        .selectAll(".landers-triggered")
        .data(dataTriggered.features)
        .attr("r", 10)
        .attr("fill", d => d.properties.mag > 5 ? "#DC0505" : "#373536")
        .style("opacity", d => d.properties.mag > 5 ? 1 : 0.5)
        .attr("cx", d => timeScaleTriggered(d.properties.day))
        .attr("cy", d => height - margin.bottom - (d.properties.id_day * 20));

    };
    function highlightChart(dataBefore, dataTriggered) {
      before
        .selectAll(".landers-before")
        .data(dataBefore.features)
        .transition()
        .delay(300)
        .duration(1000)
        .attr("fill", d => d.properties.mag > 5 ? "#DC0505" : "#373536")
        .style("opacity", d => d.properties.mag > 5 ? 1 : 0.5);

      trigger
        .selectAll(".landers-triggered")
        .data(dataTriggered.features)
        .transition()
        .delay(300)
        .duration(1000)
        .attr("fill", d => d.properties.mag > 5 ? "#DC0505" : "#373536")
        .style("opacity", d => d.properties.mag > 5 ? 1 : 0.5);
    };
    function reverseHighlightChart(dataBefore, dataTriggered) {
      before
        .selectAll(".landers-before")
        .data(dataBefore.features)
        .transition()
        .delay(700)
        .duration(1000)
        .attr("fill", "#373536")
        .style("opacity", 1);

      trigger
        .selectAll(".landers-triggered")
        .data(dataTriggered.features)
        .transition()
        .delay(700)
        .duration(1000)
        .attr("fill", "#373536")
        .style("opacity", 1);
    };
    //function to draw stacked dot histogram
    function reverseChart(dataBefore, dataTriggered) {
      aScale.domain([2.5, 7.3]);
      colorScale.domain([2.5, 7.3]);
      timeScaleBefore.domain(d3.extent(dataBefore.features.map(d => d.properties).map(d => d.day)));
      timeScaleTriggered.domain(d3.extent(dataTriggered.features.map(d => d.properties).map(d => d.day)));

      before
        .selectAll(".landers-before")
        .data(dataBefore.features)
        .transition()
        .attr("r", d => aScale(d.properties.mag))
        .style("opacity", 0.3)
        .attr("fill", "#515151");
      update();

      trigger
        .selectAll(".landers-triggered")
        .data(dataTriggered.features)
        .transition()
        .attr("r", d => aScale(d.properties.mag))
        .style("opacity", 0.7)
        .attr("fill", d => colorScale(d.properties.mag));

      update();
      // Update on map interaction
      //map.on("viewreset", update);
      //map.on("move", update);
      //map.on("moveend", update);

    };

    //function to remove selected points
    function eraseData(pointClass) {
      d3.selectAll(pointClass).remove()
    }
    //function to fade opacity of selected points
    function fadeData(pointClass) {
      svg.selectAll(pointClass)
        .transition()
        .duration(500)
        .style("opacity", 0.3)
        .attr("fill", "#515151");
    }

    ///if we have time make this a real function to restore colors to faded data
    function unfadeData(pointClass) {
      colorScale.domain([2.5, 7.3]);


      svg.selectAll(pointClass)
        .transition()
        .duration(500)
        .style("opacity", 0.3)
        .attr("fill", d => colorScale(d.properties.mag))
    }

    function hideEl(myClass) {
      d3.selectAll(myClass)
        .transition()
        .duration(500)
        .style("opacity", 0);
    }


    function showEl(myClass, opacity) {
      d3.selectAll(myClass)
        .transition()
        .duration(500)
        .style("opacity", opacity);
    }

    function setMapOpacity(value) {
      d3.selectAll(".mapboxgl-canvas")
        .transition()
        .duration(500)
        .style("opacity", value);
      d3.selectAll(".mapboxgl-control-container")
        .transition()
        .duration(500)
        .style("opacity", value);
    }

    function showMap() {
      setMapOpacity(1);
      // Enable map interaction
      map.doubleClickZoom.enable();
      map.scrollZoom.enable();
      map.dragPan.enable();
    }

    function hideMap() {
      setMapOpacity(0.1);
      // Disable map interaction
      map.doubleClickZoom.disable();
      map.scrollZoom.disable();
      map.dragPan.disable();
    }


    // initialize the scrollama
    var scroller = scrollama();

    // scrollama event handlers
    function handleStepEnter(response) {
      // response = { element, direction, index }
      console.log(response);
      // add to color to current step
      response.element.classList.add('active');
      if (response.element.attributes['step-num'].value === '12') {
        map.setPaintProperty('strainWaves', 'fill-opacity', 0.4)
      };
      if (response.direction === 'down') {
        if (response.element.attributes['step-num'].value === '2') {
          map.flyTo(chapters['section1']);
          initData(landers_before_url, before, "landers-before", [2.5, 7.3], [0, 500], 1500); //range [0,4000] when not debugging
        };
        if (response.element.attributes['step-num'].value === '3') {
          initData(landers_mainshock_url, mainshock, "landers-mainshock", [2.5, 7.3], [0, 4000], 700, d3.easeElastic,
            1000);
        }
        if (response.element.attributes['step-num'].value === '4') {
          initData(landers_aftershocks_url, aftershock, "landers-aftershocks", [2.5, 7.3], [0, 700]);
        }
        if (response.element.attributes['step-num'].value === '5') {
          initData(landers_triggered_url, trigger, "landers-triggered", [2.5, 7.3], [0, 500]); //range [0,4000] when not debugging
        }
        if (response.element.attributes['step-num'].value === '6') {
          hideMap();
          hideEl(".landers-aftershocks,.landers-mainshock");
          initChart(landers_before_url, landers_triggered_url);
        }
        if (response.element.attributes['step-num'].value === '7') {
          initChartHighlight(landers_before_url, landers_triggered_url);
        }
        if (response.element.attributes['step-num'].value === '9') {
          map.flyTo(chapters['welcome']);
          initData(sumatra_before_url, before, "sumatra-before", [2.5, 7.3], [0, 500], 1500); //range [0,4000] when not debugging
        };
        if (response.element.attributes['step-num'].value === '10') {
          initData(sumatra_mainshock_url, mainshock, "sumatra-mainshock", [2.5, 7.3], [0, 4000], 700, d3.easeElastic,
            1000); //range [0,4000] when not debugging
        };
        if (response.element.attributes['step-num'].value === '11') {
          initData(sumatra_triggered_url, trigger, "sumatra-triggered", [2.5, 7.3], [0, 500]); //range [0,4000] when not debugging
        };

      };
      if (response.direction === 'up') {
        if (response.element.attributes['step-num'].value === '1') {
          map.flyTo(chapters['welcome']);
        }
        if (response.element.attributes['step-num'].value === '5') {
          showMap();
          eraseData(".chart-axis,.mainshock-line,.chart-label,.myArrow");
          exitChart(landers_before_url, landers_triggered_url);
          showEl(".landers-aftershocks,.landers-mainshock", 0.7);
          map.flyTo(chapters['section1']);
        }
        if (response.element.attributes['step-num'].value === '6') {
          exitChartHighlight(landers_before_url, landers_triggered_url);
          //showEl(".chart-axis,.mainshock-line,.landers-before,.landers-triggered,.myArrow,.chart-label");
        }
        if (response.element.attributes['step-num'].value === '7') {
          hideMap();
          showEl(".chart-axis,.mainshock-line,.landers-before,.landers-triggered,.myArrow,.chart-label");
          initChartBackwards(landers_before_url, landers_triggered_url);
        }
      }
    };

    function handleStepExit(response) {
      // response = { element, direction, index }
      console.log(response);
      // remove color from current step
      response.element.classList.remove('active');
      if (response.element.attributes['step-num'].value === '12') {
        map.setPaintProperty('strainWaves', 'fill-opacity', 0)
      };
      if (response.direction === 'down') {
        if (response.element.attributes['step-num'].value === '2') {
          fadeData(".landers-before");

        }
        if (response.element.attributes['step-num'].value === '4') {
          fadeData(".landers-aftershocks");

        }
        if (response.element.attributes['step-num'].value === '5') {
          fadeData(".landers-triggered");

        }
        if (response.element.attributes['step-num'].value === '6') {
          //showMap();
          //hideEl(".chart-axis,.mainshock-line,.landers-before,.landers-triggered,.chart-label,.myArrow");
        }
        if (response.element.attributes['step-num'].value === '7') {
          hideEl(".chart-axis,.mainshock-line,.landers-before,.landers-triggered,.myArrow,.chart-label");
          showMap();
        }
        if (response.element.attributes['step-num'].value === '9') {
          fadeData(".sumatra-before");
        };
        if (response.element.attributes['step-num'].value === '11') {

        };

      };
      if (response.direction === 'up') {
        if (response.element.attributes['step-num'].value === '2') {
          eraseData(".landers-before");

        };
        if (response.element.attributes['step-num'].value === '3') {
          eraseData(".landers-mainshock");

        }
        if (response.element.attributes['step-num'].value === '4') {
          eraseData(".landers-aftershocks");

        }
        if (response.element.attributes['step-num'].value === '5') {
          eraseData(".landers-triggered");

        }
        if (response.element.attributes['step-num'].value === '9') {
          eraseData(".sumatra-before");
        };
        if (response.element.attributes['step-num'].value === '10') {
          eraseData(".sumatra-mainshock");
        };
        if (response.element.attributes['step-num'].value === '11') {
          eraseData(".sumatra-triggered");
        };

      }
    }

    function init() {
      // 1. setup the scroller with the bare-bones options
      // 		this will also initialize trigger observations
      // 2. bind scrollama event handlers (this can be chained like below)
      scroller.setup({
          step: '.step',
          debug: false,
          offset: 0.3
        })
        .onStepEnter(handleStepEnter)
        .onStepExit(handleStepExit);

      // 3. setup resize event
      window.addEventListener('resize', scroller.resize);
    }

    // kick things off
    init();




    //////////////////////////////////////////////////////////////////
    ///////////////
    ///Old Stuff///
    ///////////////


    /*map.on('load', function () {

      map.addSource("indianOcean_aftershocks", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/5d41e555f64d27f19ff6518b0d779efd/raw/1f4b1ecd4b8c6ecb3e25e48cdff17240b01558eb/indianOcean_aftershocks.geojson"
      });
      map.addSource("indianOcean_before", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/40d8803b4eed82851e617d8eb264bea7/raw/83d4f1a0276319cfe8f8af451c662340fbf4e581/indianOcean_before.geojson"
      });
      map.addSource("indianOcean_mainshock", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/5e3e1470002a9bb53465c610faea0959/raw/07c39e495864ecc02aa5b683379af33e3dc9a259/indianOcean_mainshock.geojson"
      });
      map.addSource("indianOcean_triggered", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/800af0c4317257f7ef066d648daa9bfc/raw/3ede95367400e22666171617ae6cb158a671cdb8/indianOcean_triggered.geojson"
      });

      map.addSource("landers_aftershocks", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/ab84dc036cbe1f444bc27a349bb1a8bb/raw/962b541ef08baaaf10479b88306ca467f7ced355/landers_aftershocks.geojson"
      });
      map.addSource("landers_before", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/788da2914f1f7ff5866d9bfb19d2b604/raw/801f798b8c4e3df875ad64558049aa849370d11c/landers_before.geojson"
      });
      map.addSource("landers_mainshock", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/97555d4d4870f6acb2d3ca6708a5c61d/raw/3b78c10904ccfd968d5c06b6c8a04f0edc724273/landers_mainshock.geojson"
      });
      map.addSource("landers_triggered", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/09f382961528be682a73029fd22b9cb1/raw/d69b210bb82cf7bff22d9eee4e3573ed01d2967f/landers_triggered.geojson"
      });

      map.addSource("tohoku_mainshock", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/60b33af5567a82a13d21fbd5c5161ff2/raw/fccd7f76b1535d89c6c37384f9db6cc43bac6dcc/tohoku_mainshock.geojson"
      });
      map.addSource("tohoku_baja_after", {
        type: "geojson",
        data: "https://gist.githubusercontent.com/will-r-chase/e5ce036f3af9030ec56c58ab660b2003/raw/d217d3c4162ea77435b8907b8008b3a0c9fc4bd0/tohoku_baja_after2.geojson"
      });*/
  </script>
</body>

</html>
